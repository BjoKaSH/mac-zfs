# -*- mode: makefile -*-
#
# gmake based Makefiles for maczfs.
#
# This file describes a set of related build targets.  It does not do
# the actual build, but merely describes what to build and which
# ingredients go into that specific build.
#
# The format is straight-forward:
#
# 1) first specify the targets.  
# 2) for each target, specify sources files, install files and used libraries.
# 3) at the very end, include Makefile.Rules.
#


# Build host specific definitions should go into Makefile-host.
#
# For example, if you get weired linker errors or missing / doubled
# definitions, then make sure your CPATH and LIBRARY_PATH do not contain
# unwanted extra includes or libraries. 
#
# Example: fix library problems with macports & Co.
#CPATH :=
#export CPATH
#LIBRARY_PATH :=
#export LIBRARY_PATH


# 1) what to build
#
# specify executables, libraries and kernel extensions.  Do *not* use
# extensions like ".exe" or ".a" etc.!
#
# here go all normal executable files:
ALL_EXE := zfs zpool zfsutil zoink

#
# here go all libraries build in this folder.  Do not specify
# libraries used here but build elsewhere!
ALL_LIBS := libzfs

#
# all kernel extensions
ALL_KEXT := zfskext


# 2) what makes up a target.
#
# specify the sources *including* path, starting form project root,
# i.e. starting with usr/src/...
# 
# NOTE: It is currently NOT supported to have two source files of the
# same name but in different directories within one target!
# 
# Targets are specified using a set of variables, all prefixed with the
# target's name and an underscore.  The available variables are:
#
# tget_SOURCES  : all source files
# tget_ARCH     : the architectures to build.  Defaults to all available.
# tget_LIBS     : used libraries for this project.  specify just the
#    library name i.e. libzfs, without an extension.  Linkage will be
#    dynamic if supported, static otherwise.  To force either one, add
#    the library (w/o extension) to tget_LIBS_DY or tget_LIBS_AR.
# tget_LDLIBS   : additional system libraries to link in.  Specify as
#    for the dynamic linker, i.e. use "-lc" to link in libc.  Only
#    evaluated when creating a dynamic library.
# tget_INC      : additional include directories to use.
# tget_INCSYS   : additional system include directories to be added
#    with "-isystem".
# tget_INSTHDRS : list of header files that should be installed along a
#    library.
# tget_INSTHDRSDIR : directory where to install the headers.  This is
#    interpreted relative to the install base defined in
#    Makefile-host.  Defaults to an architecture specific path.
# tget_CFLAGS   : extra flags to pass to the compiler
# tget_CXXFLAGS : same for C++ code
# tget_LDFLAGS  : extra flags to pass to the (dynamic) linker
# tget_DYLIB    : what type of library to build.  Empty or NO for static
#    library and YES for a dynamic library.  Only allowed in a library
#    target specification.
# tget_VERS     : version information for a dynamic library.  Should be
#    a single integer.  Mandatory for dynamic libraries.
# tget_INSTARLIB : wether or not to install a static library.  YES to
#    install (in tget_INSTLIBDIR), empty or NO otherwise.  Automatically
#    set to YES if tget_DYLIB is YES but dynamic libraries are not
#    supported by the current architecture.
# tget_INSTLIBDIR : directory where to install dynamic libraries.  This
#    is interpreted relative to the install base defined in Makefile-host.
#    Defaults to an architecture dependent path.
# tget_INSTEXEDIR : directory where to install executable files.  This
#    is interpreted relative to the install base defined in Makefile-host.
#    Defaults to an architecture dependent path.
# tget_VERSION    : file version number.  If set, then a special file
#    tget_vers.c will be generated which provides Apple's executable file
#    version mechanism.  The version number should be in the format of
#    a.b.c with a,b and c positive integer numbers.
# tget_DESCRIPTION : Optional longer, free-text description, for example
#    a tag from a SCM system.  Ignored if tget_VERSION is empty.
# tget_VERS_C      : name of a user-supplied version info file.
#    Overrides the auto-generated one from tget_VERSION.  Must be a
#    compilable C source including path relative to project root.  If
#    set, then this is used independently of tget_VERSION being defined
#    or not.
#
# All variables, with the exception of tget_ARCH, can be prefixed with
# an architecture to apply same flags, libraries, sources or other
# settings only for the given architecture, e.g. tget_ppc_CFLAGS :=
# xxx.  For most variables, the architecture specific value is
# appended to the generic value.  The architecture specific values for
# the variables DYLIB, VERS, INSTHDRSDIR, INSTLIBDIR, INSTEXEDIR,
# INSTKEXTDIR, INSTARLIB, VERSION, DESCRIPTION and VERS_C override the
# respective generic values.
# 
# You can invent other variables to simplify filling in above
# variables.  Any such invented variables should use lower case, since
# upper case names are reserved for the build system's internal use.
# See README_buildsystem.txt file for a list of used variables.

src := usr/src

# base identifier.  note that this is only the prefix, the string
# ".zfs.fs" will be added.
identifier ?= org.maczfs

libzfs_SOURCES := $(addprefix $(src)/common/,avl/avl.c devid/devid.c nvpair/nvpair.c nvpair/nvpair_alloc_fixed.c util/qsort.c zfs/zfs_deleg.c zfs/zfs_namecheck.c zfs/zfs_prop.c)
libzfs_SOURCES += $(addprefix $(src)/lib/,libdevid/deviceid.c libnsl/rpc/xdr.c libnsl/rpc/xdr_array.c libnsl/rpc/xdr_mem.c libnvpair/libnvpair.c libnvpair/nvpair_alloc_system.c)
libzfs_SOURCES += $(addprefix $(src)/lib/libuutil/common/,uu_alloc.c uu_avl.c uu_dprintf.c uu_ident.c uu_list.c uu_misc.c uu_open.c uu_pname.c uu_strtoint.c)
libzfs_SOURCES += $(addprefix $(src)/lib/libzfs/common/,libzfs_changelist.c libzfs_config.c libzfs_dataset.c libzfs_graph.c libzfs_import.c libzfs_mount.c libzfs_pool.c libzfs_status.c libzfs_util.c)
libzfs_SOURCES += $(addprefix $(src)/,libgen/common/mkdirp.c maczfs/assfail.c)

libzfs_DYLIB := YES
libzfs_VERS := 1
libzfs_LDLIBS := -lc
libzfs_CFLAGS := -include usr/src/uts/common/fs/zfs/sys/zfs_context.h -include usr/src/uts/common/sys/types.h -DTEXT_DOMAIN=0
libzfs_INCSYS := $(addprefix $(src)/,maczfs libgen/common lib/libzfs/common lib/libuutil/common common/zfs)  $(addprefix $(src)/lib/,libdevid libnsl/rpc libnsl/include libnvpair)  $(addprefix $(src)/,head uts/common uts/common/fs/zfs lib uts/common/sys) $(src)

libzfs_INSTHDRS := $(addprefix $(src)/common/,devid/devid_impl.h util/qsort.h zfs/zfs_deleg.h zfs/zfs_namecheck.h zfs/zfs_prop.h)
libzfs_INSTHDRS += $(addprefix $(src)/lib/,libdevid/libdevid.h libnsl/include/mt.h libnsl/rpc/rpc_mt.h libnvpair/libnvpair.h libuutil/common/libuutil.h libuutil/common/libuutil_common.h libuutil/common/libuutil_impl.h libzfs/common/libzfs.h libzfs/common/libzfs_impl.h libzfs/common/libzfs_ioctl.h)
libzfs_INSTHDRS += $(addprefix $(src)/uts/common/,fs/zfs/sys/zvol.h rpc/types.h rpc/xdr.h sys/fs/zfs.h sys/mntent.h sys/mnttab.h)

libzfs_ppc_CFLAGS := -DMAC_OS_X_VERSION_MIN_REQUIRED=MAC_OS_X_VERSION_10_5 -mmacosx-version-min=10.5 -isysroot /Developer/SDKs/MacOSX10.5.sdk 
libzfs_i386_5_CFLAGS := $(libzfs_ppc_CFLAGS)


zfs_SOURCES := $(addprefix $(src)/,cmd/zfs/zfs_iter.c cmd/zfs/zfs_main.c maczfs/assfail.c)
zfs_LIBS := libzfs
zfs_LDLIBS := -lc
zfs_CFLAGS := -include usr/src/uts/common/fs/zfs/sys/zfs_context.h -include usr/src/uts/common/sys/types.h
zfs_INCSYS := $(addprefix $(src)/,head uts/common/fs/zfs uts/common cmd/zfs maczfs lib/libzfs/common lib/libuutil/common lib/libnvpair) $(src)

zfs_INSTEXEDIR := usr/sbin

zfs_ppc_CFLAGS := -DMAC_OS_X_VERSION_MIN_REQUIRED=MAC_OS_X_VERSION_10_5 -mmacosx-version-min=10.5 -isysroot /Developer/SDKs/MacOSX10.5.sdk 
zfs_i386_5_CFLAGS := $(zfs_ppc_CFLAGS)


zpool_SOURCES := $(addprefix $(src)/,cmd/zpool/zpool_iter.c cmd/zpool/zpool_main.c cmd/zpool/zpool_util.c cmd/zpool/zpool_vdev.c maczfs/assfail.c)
zpool_LIBS := libzfs
zpool_LDLIBS := -lc
zpool_CFLAGS := -include usr/src/uts/common/fs/zfs/sys/zfs_context.h -include usr/src/uts/common/sys/types.h
zpool_INCSYS := $(addprefix $(src)/,head uts/common/fs/zfs uts/common cmd/zpool maczfs lib/libzfs/common lib/libuutil/common lib/libnvpair)  $(src)

zpool_INSTEXEDIR := usr/sbin

zpool_ppc_CFLAGS := -DMAC_OS_X_VERSION_MIN_REQUIRED=MAC_OS_X_VERSION_10_5 -mmacosx-version-min=10.5 -isysroot /Developer/SDKs/MacOSX10.5.sdk 
zpool_i386_5_CFLAGS := $(zpool_ppc_CFLAGS)


zfsutil_SOURCES := zfs_bundle/zfsutil.c $(src)/maczfs/assfail.c
zfsutil_INSTNAME := zfs.util
zfsutil_LIBS := libzfs
zfsutil_LDLIBS := -lc
zfsutil_CFLAGS := -include usr/src/uts/common/fs/zfs/sys/zfs_context.h -include usr/src/uts/common/sys/types.h
zfsutil_INCSYS := $(addprefix $(src)/,head uts/common/fs/zfs uts/common cmd/zpool maczfs lib/libzfs/common lib/libuutil/common lib/libnvpair)  $(src)

zfsutil_INSTEXEDIR := System/Library/Filesystems/zfs.fs

zfsutil_ppc_CFLAGS := -DMAC_OS_X_VERSION_MIN_REQUIRED=MAC_OS_X_VERSION_10_5 -mmacosx-version-min=10.5 -isysroot /Developer/SDKs/MacOSX10.5.sdk 
zfsutil_i386_5_CFLAGS := $(zfsutil_ppc_CFLAGS)


zoink_SOURCES := zfs_commands/zoink/zoink.c $(src)/maczfs/assfail.c
zoink_LIBS := libzfs
zoink_LDLIBS := -lc -lcurses
zoink_CFLAGS := -include usr/src/uts/common/fs/zfs/sys/zfs_context.h -include usr/src/uts/common/sys/types.h
zoink_INCSYS := $(addprefix $(src)/,head uts/common/fs/zfs uts/common cmd/zpool maczfs lib/libzfs/common lib/libuutil/common lib/libnvpair)  $(src)

zoink_INSTEXEDIR := usr/local/bin

zoink_ppc_CFLAGS := -DMAC_OS_X_VERSION_MIN_REQUIRED=MAC_OS_X_VERSION_10_5 -mmacosx-version-min=10.5 -isysroot /Developer/SDKs/MacOSX10.5.sdk 
zoink_i386_5_CFLAGS := $(zoink_ppc_CFLAGS)


zfskext_SOURCES := $(addprefix $(src)/common/,avl/avl.c nvpair/nvpair.c util/qsort.c zfs/zfs_deleg.c zfs/zfs_namecheck.c zfs/zfs_prop.c)
zfskext_SOURCES += $(addprefix $(src)/maczfs/,assfail.c kernel/maczfs_kernel.c kernel/zfs_context.c)
zfskext_SOURCES += $(addprefix $(src)/uts/common/fs/zfs/,arc.c bplist.c dbuf.c dmu.c dmu_object.c dmu_objset.c dmu_send.c dmu_traverse.c dmu_tx.c dmu_zfetch.c)
zfskext_SOURCES += $(addprefix $(src)/uts/common/fs/zfs/,dnode.c dnode_sync.c dsl_dataset.c dsl_deleg.c dsl_dir.c dsl_pool.c dsl_prop.c dsl_synctask.c fletcher.c gzip.c lzjb.c metaslab.c refcount.c)
zfskext_SOURCES += $(addprefix $(src)/uts/common/fs/zfs/,rprwlock.c sha256.c spa.c spa_config.c spa_errlog.c spa_history.c spa_misc.c space_map.c txg.c uberblock.c unique.c vdev.c vdev_cache.c)
zfskext_SOURCES += $(addprefix $(src)/uts/common/fs/zfs/,vdev_disk.c vdev_file.c vdev_label.c vdev_mirror.c vdev_missing.c vdev_queue.c vdev_raidz.c vdev_root.c zap.c zap_leaf.c zap_micro.c)
zfskext_SOURCES += $(addprefix $(src)/uts/common/fs/zfs/,zfs_acl.c zfs_byteswap.c zfs_ctldir.c zfs_dir.c zfs_fm.c zfs_ioctl.c zfs_log.c zfs_replay.c zfs_rlock.c zfs_vfsops.c zfs_vnops.c)
zfskext_SOURCES += $(addprefix $(src)/uts/common/fs/zfs/,zfs_vnops_macosx.c zfs_znode.c zil.c zio.c zio_checksum.c zio_compress.c zio_inject.c zvol.c)
zfskext_SOURCES += $(addprefix $(src)/uts/common/os/,callb.c kmem.c list.c nvpair_alloc_system.c taskq.c)
zfskext_SOURCES += $(addprefix $(src)/uts/common/rpc/,xdr.c xdr_array.c xdr_mem.c) $(src)/uts/common/zmod/zmod.c

zfskext_CFLAGS := -mkernel -DNAMEDSTREAMS -D__APPLE_API_UNSTABLE -D_KERNEL -DKERNEL -DKERNEL_PRIVATE -DDRIVER_PRIVATE
zfskext_CFLAGS += -nostdinc -finline -fno-keep-inline-functions -Wmissing-prototypes -Wunused-function -Wunused-label -w -Wshadow -Wnewline-eof -Wno-deprecated-declarations
zfskext_CFLAGS += -include $(src)/uts/common/fs/zfs/sys/zfs_context.h -include $(src)/uts/common/sys/types.h 

zfskext_INC := 

zfskext_LDFLAGS := -lcpp_kext -Xlinker -kext -nostdlib -lkmodc++  -lkmod -lcc_kext

zfskext_KEXT_START := zfs_module_start
zfskext_KEXT_STOP := zfs_module_stop
zfskext_KEXT_ID := $(identifier).zfs.fs
zfskext_KEXT_DESCRIPTION := $(shell git describe --tags --long --match 'maczfs*' 2> /dev/null)
zfskext_KEXT_VERSION := $(shell echo $(zfskext_KEXT_DESCRIPTION) | awk -f support/version.awk)
zfskext_KEXT_PLIST := zfs_kext/Info.plist

zfskext_VERSION := $(zfskext_KEXT_VERSION)
zfskext_DESCRIPTION := $(zfskext_KEXT_DESCRIPTION)

zfskext_INSTNAME := zfs
zfskext_INSTKEXTDIR := System/Library/Extensions
zfskext_KEXT_KERNEL := /mach_kernel

zfskext_i386_CFLAGS :=  -DMAC_OS_X_VERSION_MIN_REQUIRED=MAC_OS_X_VERSION_10_6
zfskext_i386_INC := $(src) $(addprefix $(src)/,maczfs common/avl common/nvpair common/util common/zfs maczfs/kernel uts/common/ uts/common/fs uts/common/os uts/common/rpc uts/common/zmod uts/common/fs/zfs)  /System/Library/Frameworks/Kernel.framework/PrivateHeaders /System/Library/Frameworks/Kernel.framework/Headers

zfskext_x86_64_CFLAGS :=  -DMAC_OS_X_VERSION_MIN_REQUIRED=MAC_OS_X_VERSION_10_6
zfskext_x86_64_INC := $(src) $(addprefix $(src)/,maczfs common/avl common/nvpair common/util common/zfs maczfs/kernel uts/common/ uts/common/fs uts/common/os uts/common/rpc uts/common/zmod uts/common/fs/zfs)  /System/Library/Frameworks/Kernel.framework/PrivateHeaders /System/Library/Frameworks/Kernel.framework/Headers

zfskext_ppc_CFLAGS := -DMAC_OS_X_VERSION_MIN_REQUIRED=MAC_OS_X_VERSION_10_5 -mmacosx-version-min=10.5 -isysroot /Developer/SDKs/MacOSX10.5.sdk 
zfskext_ppc_INC := $(src) $(addprefix $(src)/,maczfs common/avl common/nvpair common/util common/zfs maczfs/kernel uts/common/ uts/common/fs uts/common/os uts/common/rpc uts/common/zmod uts/common/fs/zfs)  $(addprefix /Developer/SDKs/MacOSX10.5.sdk,/System/Library/Frameworks/Kernel.framework/PrivateHeaders /System/Library/Frameworks/Kernel.framework/Headers)

zfskext_i386_5_CFLAGS := -DMAC_OS_X_VERSION_MIN_REQUIRED=MAC_OS_X_VERSION_10_5 -mmacosx-version-min=10.5 -isysroot /Developer/SDKs/MacOSX10.5.sdk 
zfskext_i386_5_INC := $(src) $(addprefix $(src)/,maczfs common/avl common/nvpair common/util common/zfs maczfs/kernel uts/common/ uts/common/fs uts/common/os uts/common/rpc uts/common/zmod uts/common/fs/zfs)  $(addprefix /Developer/SDKs/MacOSX10.5.sdk,/System/Library/Frameworks/Kernel.framework/PrivateHeaders /System/Library/Frameworks/Kernel.framework/Headers)

# 3) include Makefile.Rules
#
# This has all the magic that does the actual multi-architecture builds.
include ./Makefile.Rules

.PHONY: release

export $(foreach i2,$(ARCH_AVAIL),$(foreach i,$(ALL_EXE),$(i)_$(i2)_INSTEXEDIR_FIN))
export $(foreach i2,$(ARCH_AVAIL),$(foreach i,$(ALL_EXE),$(i)_$(i2)_INSTNAME_FIN))
export $(foreach i2,$(ARCH_AVAIL),$(foreach i,$(ALL_LIBS),$(i)_$(i2)_INSTLIBDIR_FIN))
export $(foreach i2,$(ARCH_AVAIL),$(foreach i,$(ALL_LIBS),$(i)_$(i2)_INSTNAME_FIN))
export $(foreach i2,$(ARCH_AVAIL),$(foreach i,$(ALL_KEXT),$(i)_$(i2)_INSTKEXTDIR_FIN))
export $(foreach i2,$(ARCH_AVAIL),$(foreach i,$(ALL_KEXT),$(i)_$(i2)_INSTNAME_FIN))

install_version := $(shell ./support/version.sh)
build_user := $(shell id -un)
build_group := $(shell id -gn)
install_user := root
install_group := wheel


release: install
	mkdir -pv build/ZFS105 build/ZFS106
	@echo Preparing MacOS 10.6.x package
	set -x -v ; for i in $(ALL_EXE) ; do n386=$${i}_i386_INSTEXEDIR_FIN; in386=$${i}_i386_INSTNAME_FIN; n64=$${i}_x86_64_INSTEXEDIR_FIN; in64=$${i}_x86_64_INSTNAME_FIN; p386=$(INSTBASE)/i386/$${!n386}/$${!in386}; mkdir -pv build/ZFS106/$${!n386}; lipo $${p386} $(INSTBASE)/x86_64/$${!n64}/$${!in64} -create -output build/ZFS106/$${!n386}/$${!in386} ; dsymutil --verbose build/ZFS106/$${!n386}/$${!in386} ; done
	set -x -v ; for i in $(ALL_LIBS) ; do n386=$${i}_i386_INSTLIBDIR_FIN; in386=$${i}_i386_INSTNAME_FIN; n64=$${i}_x86_64_INSTLIBDIR_FIN; in64=$${i}_x86_64_INSTNAME_FIN; p386=$(INSTBASE)/i386/$${!n386}/$${!in386}; if [ -e "$${p386}.dylib" ] ; then mkdir -pv build/ZFS106/$${!n386}; lipo $${p386}.dylib $(INSTBASE)/x86_64/$${!n64}/$${!in64}.dylib -create -output build/ZFS106/$${!n386}/$${!in386}.dylib ; dsymutil --verbose build/ZFS106/$${!n386}/$${!in386}.dylib ; else echo "skipping archive $${i}" ; fi ; done
	@echo
	mkdir -pv  build/ZFS106/$${zfskext_i386_INSTKEXTDIR_FIN}
	cp -pr $(INSTBASE)/i386/$${zfskext_i386_INSTKEXTDIR_FIN}/zfs.kext build/ZFS106/$${zfskext_i386_INSTKEXTDIR_FIN}/
	lipo $(INSTBASE)/i386/$${zfskext_i386_INSTKEXTDIR_FIN}/zfs.kext/Contents/MacOS/zfs $(INSTBASE)/x86_64/$${zfskext_i386_INSTKEXTDIR_FIN}/zfs.kext/Contents/MacOS/zfs  -create -output build/ZFS106/$${zfskext_i386_INSTKEXTDIR_FIN}/zfs.kext/Contents/MacOS/zfs
	dsymutil --verbose build/ZFS106/$${zfskext_i386_INSTKEXTDIR_FIN}/zfs.kext/Contents/MacOS/zfs
	@echo
	mkdir -pv build/ZFS106/System/Library/Filesystems/zfs.fs/Contents/Resources/English.lproj
	cp -v zfs_bundle/Info.plist zfs_bundle/PkgInfo  build/ZFS106/System/Library/Filesystems/zfs.fs/Contents/
	cp -v zfs_bundle/VolumeIcon.icns  build/ZFS106/System/Library/Filesystems/zfs.fs/Contents/Resources/
	cp -vr zfs_bundle/English.lproj  build/ZFS106/System/Library/Filesystems/zfs.fs/Contents/Resources/
	@echo
	@echo Preparing MacOS 10.5.x package
	for i in $(ALL_EXE) ; do n386_5=$${i}_i386_5_INSTEXEDIR_FIN; in386_5=$${i}_i386_5_INSTNAME_FIN; nppc=$${i}_ppc_INSTEXEDIR_FIN; inppc=$${i}_ppc_INSTNAME_FIN; p386_5=$(INSTBASE)/i386_5/$${!n386_5}/$${!in386_5}; mkdir -pv build/ZFS105/$${!n386_5}; lipo $${p386_5} $(INSTBASE)/ppc/$${!nppc}/$${!inppc} -create -output build/ZFS105/$${!n386_5}/$${!in386_5} ; dsymutil --verbose build/ZFS105/$${!n386_5}/$${!in386_5} ; done
	for i in $(ALL_LIBS) ; do n386_5=$${i}_i386_5_INSTLIBDIR_FIN; in386_5=$${i}_i386_5_INSTNAME_FIN; nppc=$${i}_ppc_INSTLIBDIR_FIN; inppc=$${i}_ppc_INSTNAME_FIN; p386_5=$(INSTBASE)/i386_5/$${!n386_5}/$${!in386_5}; if [ -e "$${p386_5}.dylib" ] ; then mkdir -pv build/ZFS105/$${!n386_5}; lipo $${p386_5}.dylib $(INSTBASE)/ppc/$${!nppc}/$${!inppc}.dylib -create -output build/ZFS105/$${!n386_5}/$${!in386_5}.dylib ; dsymutil --verbose build/ZFS105/$${!n386_5}/$${!in386_5}.dylib ; else echo "skipping archive $${i}" ; fi ; done
	@echo
	mkdir -pv  build/ZFS105/$${zfskext_i386_5_INSTKEXTDIR_FIN}
	cp -pr $(INSTBASE)/i386_5/$${zfskext_i386_5_INSTKEXTDIR_FIN}/zfs.kext build/ZFS105/$${zfskext_i386_5_INSTKEXTDIR_FIN}/
	lipo $(INSTBASE)/i386_5/$${zfskext_i386_5_INSTKEXTDIR_FIN}/zfs.kext/Contents/MacOS/zfs $(INSTBASE)/ppc/$${zfskext_i386_5_INSTKEXTDIR_FIN}/zfs.kext/Contents/MacOS/zfs  -create -output build/ZFS105/$${zfskext_i386_5_INSTKEXTDIR_FIN}/zfs.kext/Contents/MacOS/zfs
	dsymutil --verbose build/ZFS105/$${zfskext_i386_5_INSTKEXTDIR_FIN}/zfs.kext/Contents/MacOS/zfs
	@echo
	mkdir -pv build/ZFS105/System/Library/Filesystems/zfs.fs/Contents/Resources/English.lproj
	cp -v zfs_bundle/Info.plist zfs_bundle/PkgInfo  build/ZFS105/System/Library/Filesystems/zfs.fs/Contents/
	cp -v zfs_bundle/VolumeIcon.icns  build/ZFS105/System/Library/Filesystems/zfs.fs/Contents/Resources/
	cp -vr zfs_bundle/English.lproj  build/ZFS105/System/Library/Filesystems/zfs.fs/Contents/Resources/
	@echo
	@echo Creating combined installer package
	cp -vr support/MacZFS.pmdoc build/ 
	sed -i~  -e "s/0\\.0\\.0/$(install_version)/g"  build/MacZFS.pmdoc/*
	sed -i~ -e "s/com.bandlem.mac/$(identifier)/g"  build/MacZFS.pmdoc/*  build/ZFS10?/System/Library/Filesystems/zfs.fs/Contents/Info.plist
	find build/ZFS10? build/MacZFS.pmdoc -iname '*~'  -print0 | xargs -0 rm -v
	@echo
	@echo "explicitly setting group and ownership, enter sudo password if prompted"
	sudo chown -Rv $(install_user):$(install_group) build/ZFS10? build/MacZFS.pmdoc
	tree -pug build/ZFS10? build/MacZFS.pmdoc
	cd build && sudo packagemaker --doc MacZFS.pmdoc --version $(install_version) --title "Mac ZFS $(install_version)" --out MacZFS-$(install_version).pkg --target 10.5
	sudo chown -R $(build_user):$(build_group) build/ZFS10? build/MacZFS.pmdoc build/MacZFS-$(install_version).pkg
